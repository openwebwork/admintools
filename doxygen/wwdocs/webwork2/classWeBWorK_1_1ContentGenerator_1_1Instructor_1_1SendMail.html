<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::ContentGenerator::Instructor::SendMail Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator.html">ContentGenerator</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">Instructor</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html">SendMail</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::ContentGenerator::Instructor::SendMail Class Reference</h1><!-- doxytag: class="WeBWorK::ContentGenerator::Instructor::SendMail" --><!-- doxytag: inherits="WeBWorK::ContentGenerator::Instructor" --><div class="dynheader">
Inheritance diagram for WeBWorK::ContentGenerator::Instructor::SendMail:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail__inherit__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail_inherit__map" id="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail_inherit__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html" title="WeBWorK::ContentGenerator::Instructor" alt="" coords="36,155,292,181"/><area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="68,80,260,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="123,5,205,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::ContentGenerator::Instructor::SendMail:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail__coll__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail_coll__map" id="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail_coll__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html" title="WeBWorK::ContentGenerator::Instructor" alt="" coords="36,155,292,181"/><area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="68,80,260,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="123,5,205,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a5c72f31f1ffb223e0ad6de93ff55574b">get_merge_file_names</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a90aea456cc32786c82e3b58e8da98c42">print_preview</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a6ea957f71c531694c04ad864166995ed">process_message</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a415ae4d9de8fd50eab0cda953bec8c39">saveProblem</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a96bb4ab8f03d755b738f9de649883cf7">initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#aebbbdf2bc79d9027d70cb1027a64c13f">email_notification</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a45b899af631c3ea1cd2e15f9452f644e">data_format2</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a330e29ea7b15e9c6d0a8ced9036b3f9f">getRecord</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#af2c75d5692e970e129c3098bb93a22ec">body</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a7a47a745018c96386c9dd6d7a7eaf2f8">get_message_file_names</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a1d096ed4e84c99a5542ebc61cd70d36d">data_format</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a67e075f06e67f3a054b19572a8d639e7">print_form</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#adf7f3bab2717d018779f3d45a611d16d">mail_message_to_recipients</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a0581f132ca99cc75b6042102b79b19ae">read_input_file</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html">WeBWorK::ContentGenerator::Instructor::SendMail</a> - Entry point for User-specific data editing </p>

<p>Definition at line <a class="el" href="SendMail_8pm_source.html#l00026">26</a> of file <a class="el" href="SendMail_8pm_source.html">SendMail.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="af2c75d5692e970e129c3098bb93a22ec"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::body" ref="af2c75d5692e970e129c3098bb93a22ec" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::body </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-body' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-body-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-body-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-body-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in body: 31</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#af2c75d5692e970e129c3098bb93a22ec">body</a> {
    my ($self)          = @_;
    my $r               = $self-&gt;r;
    my $urlpath         = $r-&gt;urlpath;
    my $authz           = $r-&gt;authz;
    my $setID           = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);    
    my $response        = (defined($self-&gt;{response}))? $self-&gt;{response} : <span class="stringliteral">&#39;&#39;</span>;
    my $user            = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);

<span class="preprocessor">    # Check permissions</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, CGI::p(<span class="stringliteral">&quot;You are not authorized to access instructor tools&quot;</span>))
        unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);

    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, CGI::p(<span class="stringliteral">&quot;You are not authorized to send mail to students&quot;</span>))
        unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;send_mail&quot;</span>);

    <span class="keywordflow">if</span> ($response eq <span class="stringliteral">&#39;preview&#39;</span>) {
        $self-&gt;print_preview($setID);
    } elsif ($response eq <span class="stringliteral">&#39;send_email&#39;</span> and $self-&gt;{ra_send_to} and @{$self-&gt;{ra_send_to}}){
        my $message = CGI::i(<span class="stringliteral">&quot;Email is being sent to &quot;</span>.  scalar(@{$self-&gt;{ra_send_to}}).<span class="stringliteral">&quot; recipient(s). You will be notified&quot;</span>
                     .<span class="stringliteral">&quot; by email when the task is completed.  This may take several minutes if the class is large.&quot;</span>
        );
        $self-&gt;addgoodmessage($message);
        $self-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a>} .= $message;
        
        $self-&gt;print_form($setID);
    } <span class="keywordflow">else</span> {
        $self-&gt;print_form($setID);
    }

}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a1d096ed4e84c99a5542ebc61cd70d36d"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::data_format" ref="a1d096ed4e84c99a5542ebc61cd70d36d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::data_format </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-data_format' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-data_format-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-data_format-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-data_format-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in data_format: 3</span>
<span class="preprocessor"></span> sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a1d096ed4e84c99a5542ebc61cd70d36d">data_format</a> {
        map {<span class="stringliteral">&quot;COL[$_]&quot;</span>.<span class="stringliteral">&#39;&amp;nbsp;&#39;</span>x(3-length($_));}  @_;  # problems <span class="keywordflow">if</span> $_ has length bigger than 4
 }
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a45b899af631c3ea1cd2e15f9452f644e"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::data_format2" ref="a45b899af631c3ea1cd2e15f9452f644e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::data_format2 </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-data_format2' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-data_format2-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-data_format2-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-data_format2-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in data_format2: 4</span>
<span class="preprocessor"></span>  sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a45b899af631c3ea1cd2e15f9452f644e">data_format2</a> {
    map {$_ =~s/\s/&amp;<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a0b04a9c84777c525b5d1a7683331f7ee">nbsp</a>;/g;$_}  map {sprintf(<span class="stringliteral">&#39;%-8.8s&#39;</span>,$_);} @_;
 }
1;
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aebbbdf2bc79d9027d70cb1027a64c13f"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::email_notification" ref="aebbbdf2bc79d9027d70cb1027a64c13f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::email_notification </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-email_notification' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-email_notification-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-email_notification-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-email_notification-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in email_notification: 35</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#aebbbdf2bc79d9027d70cb1027a64c13f">email_notification</a> {
    my $self = shift;
    my $result_message = shift;
<span class="preprocessor">    # find info on mailer and sender</span>
<span class="preprocessor"></span><span class="preprocessor">    # use the defaultFrom address.</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # find info on instructor recipient and message</span>
<span class="preprocessor"></span>    my $subject=<span class="stringliteral">&quot;WeBWorK email sent&quot;</span>;
    
    my $mailing_errors = <span class="stringliteral">&quot;&quot;</span>;
<span class="preprocessor">    # open MAIL handle</span>
<span class="preprocessor"></span>    my $mailer = Mail::Sender-&gt;new({
        from =&gt; $self-&gt;{defaultFrom},
        to   =&gt; $self-&gt;{defaultFrom},
        smtp    =&gt; $self-&gt;{smtpServer},
        subject =&gt; $subject,
        headers =&gt; <span class="stringliteral">&quot;X-Remote-Host: &quot;</span>.$self-&gt;{remote_host},
    });
    unless (ref $mailer) {
        $mailing_errors .= <span class="stringliteral">&quot;Failed to create a mailer: $Mail::Sender::Error&quot;</span>;
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
    }
    unless (ref $mailer-&gt;Open()) {
        $mailing_errors .= <span class="stringliteral">&quot;Failed to open the mailer: $Mail::Sender::Error&quot;</span>;
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
    }
    my $MAIL = $mailer-&gt;GetHandle();
<span class="preprocessor">    # print message</span>
<span class="preprocessor"></span>    print $MAIL $result_message;
<span class="preprocessor">    # clean up</span>
<span class="preprocessor"></span>    close $MAIL;
    
    warn <span class="stringliteral">&quot;instructor message sent to &quot;</span>, $self-&gt;{defaultFrom};

}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a5c72f31f1ffb223e0ad6de93ff55574b"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::get_merge_file_names" ref="a5c72f31f1ffb223e0ad6de93ff55574b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::get_merge_file_names </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_merge_file_names' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-get_merge_file_names-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_merge_file_names-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_merge_file_names-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in get_merge_file_names: 5</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a5c72f31f1ffb223e0ad6de93ff55574b">get_merge_file_names</a>   {
    my $self         = shift;
    <span class="keywordflow">return</span> <span class="stringliteral">&#39;None&#39;</span>, $self-&gt;read_dir($self-&gt;{ce}-&gt;{courseDirs}-&gt;{scoring}, <span class="stringliteral">&#39;\\.csv$&#39;</span>); #FIXME ? check that only readable files are listed.
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a7a47a745018c96386c9dd6d7a7eaf2f8"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::get_message_file_names" ref="a7a47a745018c96386c9dd6d7a7eaf2f8" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::get_message_file_names </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_message_file_names' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-get_message_file_names-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_message_file_names-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_message_file_names-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in get_message_file_names: 4</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a7a47a745018c96386c9dd6d7a7eaf2f8">get_message_file_names</a> {
    my $self         = shift;
    <span class="keywordflow">return</span> $self-&gt;read_dir($self-&gt;{ce}-&gt;{courseDirs}-&gt;{email}, <span class="stringliteral">&#39;\\.msg$&#39;</span>);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a330e29ea7b15e9c6d0a8ced9036b3f9f"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::getRecord" ref="a330e29ea7b15e9c6d0a8ced9036b3f9f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::getRecord </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-getRecord' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-getRecord-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-getRecord-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-getRecord-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in getRecord: 20</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a330e29ea7b15e9c6d0a8ced9036b3f9f">getRecord</a> {
    my $self    = shift;
    my $line    = shift;
    my $delimiter   = shift;
    $delimiter       = <span class="charliteral">&#39;,&#39;</span> unless defined($delimiter);

<span class="preprocessor">        #       Takes a delimited line as a parameter and returns an</span>
<span class="preprocessor"></span><span class="preprocessor">        #       array.  Note that all white space is removed.  If the</span>
<span class="preprocessor"></span><span class="preprocessor">        #       last field is empty, the last element of the returned</span>
<span class="preprocessor"></span><span class="preprocessor">        #       array is also empty (unlike what the perl split command</span>
<span class="preprocessor"></span><span class="preprocessor">        #       would return).  E.G. @lineArray=&amp;getRecord(\$delimitedLine).</span>
<span class="preprocessor"></span>
        my(@lineArray);
        $line.=<span class="stringliteral">&quot;${delimiter}___&quot;</span>;                       # add <span class="keyword">final</span> field which must be non-empty
        @lineArray = split(/\s*${delimiter}\s*/,$line); # split line into fields
        $lineArray[0] =~s/^\s*<span class="comment">//;                       # remove white space from first element</span>
        pop @lineArray;                                 # <span class="keyword">remove</span> the last artificial field
        @lineArray;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a96bb4ab8f03d755b738f9de649883cf7"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::initialize" ref="a96bb4ab8f03d755b738f9de649883cf7" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::initialize </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-initialize' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-initialize-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-initialize-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-initialize-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in initialize: 399</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a96bb4ab8f03d755b738f9de649883cf7">initialize</a> {
    my ($self) = @_;
    my $r      = $self-&gt;r;
    my $db     = $r-&gt;db;
    my $ce     = $r-&gt;ce;
    my $authz  = $r-&gt;authz;
    my $user   = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);

    my @selected_filters;
    <span class="keywordflow">if</span> (defined ($r-&gt;param(<span class="stringliteral">&#39;classList!filter&#39;</span>))){ @selected_filters = $r-&gt;param(<span class="stringliteral">&#39;classList!filter&#39;</span>);}
    <span class="keywordflow">else</span> {@selected_filters = (<span class="stringliteral">&quot;all&quot;</span>);}


<span class="preprocessor">    # Check permissions</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
    <span class="keywordflow">return</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;send_mail&quot;</span>);

<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #   gather directory data</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<span class="preprocessor"></span>    my $emailDirectory    =    $ce-&gt;{courseDirs}-&gt;{email};
    my $scoringDirectory  =    $ce-&gt;{courseDirs}-&gt;{scoring};
    my $templateDirectory =    $ce-&gt;{courseDirs}-&gt;{templates};
    
    my $action            =    $r-&gt;param(<span class="stringliteral">&#39;action&#39;</span>) ; 
    my $openfilename      =    $r-&gt;param(<span class="stringliteral">&#39;openfilename&#39;</span>);
    my $savefilename      =    $r-&gt;param(<span class="stringliteral">&#39;savefilename&#39;</span>);
    
    
<span class="preprocessor">    #FIXME  get these values from global course environment (see subroutines as well)</span>
<span class="preprocessor"></span>    my $default_msg_file       =    <span class="stringliteral">&#39;default.msg&#39;</span>;  
    my $old_default_msg_file   =    <span class="stringliteral">&#39;old_default.msg&#39;</span>;
    

<span class="preprocessor">    #  get user record</span>
<span class="preprocessor"></span>    my $ur = $self-&gt;{db}-&gt;getUser($user);

<span class="preprocessor">    # store data</span>
<span class="preprocessor"></span>    $self-&gt;{defaultFrom}            =   $ur-&gt;rfc822_mailbox;
    $self-&gt;{defaultReply}           =   $ur-&gt;rfc822_mailbox;
    $self-&gt;{defaultSubject}         =   $self-&gt;r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>) . <span class="stringliteral">&quot; notice&quot;</span>;

    $self-&gt;{rows}                   =   (defined($r-&gt;param(<span class="stringliteral">&#39;rows&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;rows&#39;</span>) : $ce-&gt;{mail}-&gt;{editor_window_rows};
    $self-&gt;{columns}                =   (defined($r-&gt;param(<span class="stringliteral">&#39;columns&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;columns&#39;</span>) : $ce-&gt;{mail}-&gt;{editor_window_columns};
    $self-&gt;{default_msg_file}       =   $default_msg_file;
    $self-&gt;{old_default_msg_file}   =   $old_default_msg_file;
    $self-&gt;{merge_file}             =   (defined($r-&gt;param(<span class="stringliteral">&#39;merge_file&#39;</span>  )))    ? $r-&gt;param(<span class="stringliteral">&#39;merge_file&#39;</span>)   : <span class="stringliteral">&#39;None&#39;</span>;
<span class="preprocessor">    #$self-&gt;{preview_user}           =   (defined($r-&gt;param(&#39;preview_user&#39;)))    ? $r-&gt;param(&#39;preview_user&#39;) : $user;</span>
<span class="preprocessor"></span><span class="preprocessor">    # an expermiment -- share the scrolling list for preivew and sendTo actions.</span>
<span class="preprocessor"></span>    my <span class="keyword">@class</span>List                   =   (defined($r-&gt;param(<span class="stringliteral">&#39;classList&#39;</span>)))    ? $r-&gt;param(<span class="stringliteral">&#39;classList&#39;</span>) : ($user);
    $self-&gt;{preview_user}           =   $classList[0] || $user;
    
<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #   gather database data</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<span class="preprocessor"></span><span class="preprocessor">    # FIXME  this might be better done in body? We don&#39;t always need all of this data. or do we?</span>
<span class="preprocessor"></span><span class="preprocessor">    # DBFIXME shouldn&#39;t need ID list</span>
<span class="preprocessor"></span><span class="preprocessor">    # DBFIXME do filtering in database</span>
<span class="preprocessor"></span>    my @users =  $db-&gt;listUsers;
    my @Users = $db-&gt;getUsers(@users);
<span class="preprocessor">    # filter out users who don&#39;t get included in email (fixes bug #938)</span>
<span class="preprocessor"></span>    @Users = grep { $ce-&gt;status_abbrev_has_behavior($_-&gt;status, <span class="stringliteral">&quot;include_in_email&quot;</span>) } @Users;
    my @user_records = ();

<span class="preprocessor">    ## Mark&#39;s code to prefilter userlist</span>
<span class="preprocessor"></span><span class="preprocessor">    # DBFIXME more filtering that we can do in the database</span>
<span class="preprocessor"></span>
    
    my (@viewable_sections,@viewable_recitations);
    
    <span class="keywordflow">if</span> (defined @{$ce-&gt;{viewable_sections}-&gt;{$user}})
        {@viewable_sections = @{$ce-&gt;{viewable_sections}-&gt;{$user}};}
    <span class="keywordflow">if</span> (defined @{$ce-&gt;{viewable_recitations}-&gt;{$user}})
        {@viewable_recitations = @{$ce-&gt;{viewable_recitations}-&gt;{$user}};}

    <span class="keywordflow">if</span> (@viewable_sections or @viewable_recitations){
        <span class="keywordflow">foreach</span> my $student (@Users){
            my $keep = 0;
            <span class="keywordflow">foreach</span> my $sec (@viewable_sections){
                <span class="keywordflow">if</span> ($student-&gt;section() eq $sec){$keep = 1;}
            }
            <span class="keywordflow">foreach</span> my $rec (@viewable_recitations){
                <span class="keywordflow">if</span> ($student-&gt;recitation() eq $rec){$keep = 1;}
            }
            <span class="keywordflow">if</span> ($keep) {push @user_records, $student;}
        }
    }
    <span class="keywordflow">else</span> {@user_records = @Users;}

<span class="preprocessor">    ## End Mark&#39;s code</span>
<span class="preprocessor"></span>    

<span class="preprocessor">    # replace the user names by a sorted version.</span>
<span class="preprocessor"></span>    @users                         =  map {$_-&gt;user_id} @user_records;
<span class="preprocessor">    # store data</span>
<span class="preprocessor"></span>    $self-&gt;{ra_users}              =   \@users;
    $self-&gt;{ra_user_records}       =   \@user_records;

<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #   gather list of recipients</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<span class="preprocessor"></span>    my @send_to                    =   ();  
<span class="preprocessor">    #FIXME  this (radio) is a lousy name</span>
<span class="preprocessor"></span>    my $recipients                 = $r-&gt;param(<span class="stringliteral">&#39;radio&#39;</span>);
    <span class="keywordflow">if</span> (defined($recipients) and $recipients eq <span class="stringliteral">&#39;all_students&#39;</span>) {  #only active students #FIXME status check??
        
<span class="preprocessor">        ## Add code so that only people who pass the current filters are added to our list of recipients.       </span>
<span class="preprocessor"></span><span class="preprocessor">        #   @user_records = filterRecords({filter=\@selected_filters},@user_records);</span>
<span class="preprocessor"></span><span class="preprocessor">        #  I wasn&#39;t able to make this work</span>
<span class="preprocessor"></span><span class="preprocessor">        #  I edited the selection button to make that clear.</span>
<span class="preprocessor"></span><span class="preprocessor">        #</span>
<span class="preprocessor"></span>
        <span class="keywordflow">foreach</span> my $ur (@user_records) {
            push(@send_to,$ur-&gt;user_id)
                if $ce-&gt;status_abbrev_has_behavior($ur-&gt;status, &quot;include_in_email&quot;)
                    and not $ur-&gt;user_id =~ /practice/;
        }
    } elsif (defined($recipients) and $recipients eq &#39;studentID&#39; ) {
        @send_to                   = $r-&gt;param(<span class="stringliteral">&#39;classList&#39;</span>);
    } <span class="keywordflow">else</span> {
<span class="preprocessor">        # no recipients have been defined -- probably the first time on the page</span>
<span class="preprocessor"></span>    }   
    $self-&gt;{ra_send_to}               = \@send_to;
<span class="preprocessor">    #################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Check the validity of the input file name</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################################</span>
<span class="preprocessor"></span>    my $input_file = <span class="stringliteral">&#39;&#39;</span>;
<span class="preprocessor">    #make sure an input message file was submitted and exists</span>
<span class="preprocessor"></span><span class="preprocessor">    #else use the default message       </span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( defined($openfilename) ) {
        <span class="keywordflow">if</span> ( -e <span class="stringliteral">&quot;${emailDirectory}/$openfilename&quot;</span>) {
            <span class="keywordflow">if</span> ( -R <span class="stringliteral">&quot;${emailDirectory}/$openfilename&quot;</span>) {
                $input_file = $openfilename;
            } <span class="keywordflow">else</span> {
                $self-&gt;addbadmessage(CGI::p(join(<span class="stringliteral">&quot;&quot;</span>,
                    <span class="stringliteral">&quot;The file ${emailDirectory}/$openfilename is not readable by the webserver.&quot;</span>,CGI::br(),
                    <span class="stringliteral">&quot;Check that it&#39;s permissions are set correctly.&quot;</span>,
                )));
            }
        } <span class="keywordflow">else</span> {
            $input_file = $default_msg_file;
            $self-&gt;addbadmessage(CGI::p(join(<span class="stringliteral">&quot;&quot;</span>,
                  <span class="stringliteral">&quot;The file ${emailDirectory}/$openfilename cannot be found.&quot;</span>,CGI::br(),
                  <span class="stringliteral">&quot;Check whether it exists and whether the directory $emailDirectory can be read by the webserver.&quot;</span>,CGI::br(),
                  <span class="stringliteral">&quot;Using contents of the default message $default_msg_file instead.&quot;</span>,
            )));
        }
    } <span class="keywordflow">else</span> {
        $input_file     = $default_msg_file;
    }
    $self-&gt;{input_file} =$input_file;

<span class="preprocessor">    #################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Determine the file name to save message into</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################################</span>
<span class="preprocessor"></span>    my $output_file      = <span class="stringliteral">&#39;FIXME no output file specified&#39;</span>;    
    <span class="keywordflow">if</span> (defined($action) and $action eq <span class="stringliteral">&#39;Save as Default&#39;</span>) {
        $output_file  = $default_msg_file;
    } elsif ( defined($action) and ($action =~/save/i)) {
        <span class="keywordflow">if</span> (defined($savefilename) and $savefilename ) {
            $output_file  = $savefilename;
        } <span class="keywordflow">else</span> {
            $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;No filename was specified for saving!  The message was not saved.&quot;</span>));
        }
    } elsif ( defined($input_file) ) {
        $output_file  = $input_file;
    }

<span class="preprocessor">    #################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Sanity check on save file name</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################################</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> ($output_file =~ /^[~.]/ || $output_file =~ /\.\./) {
        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;For security reasons, you cannot specify a message file from a directory&quot;</span>, 
                        <span class="stringliteral">&quot;higher than the email directory (you can&#39;t use ../blah/blah for example). &quot;</span>, 
                        <span class="stringliteral">&quot;Please specify a different file or move the needed file to the email directory&quot;</span>,));
    } 
    unless ($output_file =~ m|\.msg$| ) {
        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Invalid file name.&quot;</span>, 
                                <span class="stringliteral">&quot;The file name \&quot;$output_file\&quot; does not have a \&quot;.msg\&quot; extension&quot;</span>,
                                <span class="stringliteral">&quot;All email file names must end in the extension \&quot;.msg\&quot;&quot;</span>,
                                <span class="stringliteral">&quot;choose a file name with a \&quot;.msg\&quot; extension.&quot;</span>,
                                <span class="stringliteral">&quot;The message was not saved.&quot;</span>,));
    }

    $self-&gt;{output_file} = $output_file;  # <span class="keyword">this</span> is ok.  It will be put back in the text input box <span class="keywordflow">for</span> re-editing.


    #############################################################################################
<span class="preprocessor">    # Determine input source</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #warn &quot;Action = $action&quot;;</span>
<span class="preprocessor"></span>    my $input_source;
    <span class="keywordflow">if</span> ($action){   
        $input_source =  ( defined( $r-&gt;param(<span class="stringliteral">&#39;body&#39;</span>) ) and $action ne <span class="stringliteral">&#39;Open&#39;</span> ) ? <span class="stringliteral">&#39;form&#39;</span> : <span class="stringliteral">&#39;file&#39;</span>;}
    <span class="keywordflow">else</span> { $input_source = ( defined($r-&gt;param(<span class="stringliteral">&#39;body&#39;</span>)) ) ? <span class="stringliteral">&#39;form&#39;</span> : <span class="stringliteral">&#39;file&#39;</span>;}

<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Get inputs</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span>    my($from, $replyTo, $r_text, $subject);
    <span class="keywordflow">if</span> ($input_source eq <span class="stringliteral">&#39;file&#39;</span>) {

        ($from, $replyTo,$subject,$r_text) = $self-&gt;read_input_file(<span class="stringliteral">&quot;$emailDirectory/$input_file&quot;</span>);


    } elsif ($input_source eq <span class="stringliteral">&#39;form&#39;</span>) {
<span class="preprocessor">        # read info from the form</span>
<span class="preprocessor"></span><span class="preprocessor">        # bail if there is no message body</span>
<span class="preprocessor"></span>        
        $from              =    $r-&gt;param(<span class="stringliteral">&#39;from&#39;</span>);
        $replyTo           =    $r-&gt;param(<span class="stringliteral">&#39;replyTo&#39;</span>);
        $subject           =    $r-&gt;param(<span class="stringliteral">&#39;subject&#39;</span>);
        my $body           =    $r-&gt;param(<span class="stringliteral">&#39;body&#39;</span>);
<span class="preprocessor">        # Sanity check: body must contain non-white space</span>
<span class="preprocessor"></span>        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&#39;You didn\&#39;t enter any message.&#39;</span>)) unless ($r-&gt;param(<span class="stringliteral">&#39;body&#39;</span>) =~ /\S/);
        $r_text               =    \$body;

    }
    
    my $remote_host;
    <span class="keywordflow">if</span> (MP2) {
        $remote_host = $r-&gt;connection-&gt;remote_addr-&gt;ip_get || <span class="stringliteral">&quot;UNKNOWN&quot;</span>;
    } <span class="keywordflow">else</span> {
        (undef, $remote_host) = unpack_sockaddr_in($r-&gt;connection-&gt;remote_addr);
        $remote_host = defined $remote_host ? inet_ntoa($remote_host) : <span class="stringliteral">&quot;UNKNOWN&quot;</span>;
    }

<span class="preprocessor">    # store data</span>
<span class="preprocessor"></span>    $self-&gt;{from}                   =    $from;
    $self-&gt;{replyTo}                =    $replyTo;
    $self-&gt;{subject}                =    $subject;
    $self-&gt;{remote_host}            =    $remote_host;
    $self-&gt;{r_text}                 =    $r_text;



<span class="preprocessor">    ###################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #Determine the appropriate script action from the buttons</span>
<span class="preprocessor"></span><span class="preprocessor">    ###################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #     first time actions</span>
<span class="preprocessor"></span><span class="preprocessor">    #          open new file</span>
<span class="preprocessor"></span><span class="preprocessor">    #          open default file </span>
<span class="preprocessor"></span><span class="preprocessor">    #     choose merge file actions</span>
<span class="preprocessor"></span><span class="preprocessor">    #          chose merge button</span>
<span class="preprocessor"></span><span class="preprocessor">    #     option actions</span>
<span class="preprocessor"></span><span class="preprocessor">    #       &#39;reset rows&#39;</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    #     save actions</span>
<span class="preprocessor"></span><span class="preprocessor">    #       &quot;save&quot; button</span>
<span class="preprocessor"></span><span class="preprocessor">    #       &quot;save as&quot; button</span>
<span class="preprocessor"></span><span class="preprocessor">    #       &quot;save as default&quot; button</span>
<span class="preprocessor"></span><span class="preprocessor">    #     preview actions</span>
<span class="preprocessor"></span><span class="preprocessor">    #       &#39;preview&#39; button</span>
<span class="preprocessor"></span><span class="preprocessor">    #     email actions</span>
<span class="preprocessor"></span><span class="preprocessor">    #       &#39;entire class&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">    #       &#39;selected studentIDs&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">    #     error actions (various)</span>
<span class="preprocessor"></span>

<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # if no form is submitted, gather data needed to produce the mail form and return</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span>    my $to                =    $r-&gt;param(<span class="stringliteral">&#39;To&#39;</span>);
    my $script_action     = <span class="stringliteral">&#39;&#39;</span>;
    
    
    <span class="keywordflow">if</span>(not defined($action) or $action eq <span class="stringliteral">&#39;Open&#39;</span>  
       or $action eq $UPDATE_SETTINGS_BUTTON ){  

        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
    }

    

    

<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # If form is submitted deal with filled out forms </span>
<span class="preprocessor"></span><span class="preprocessor">    # and various actions resulting from different buttons</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span>

    <span class="keywordflow">if</span> ($action eq <span class="stringliteral">&#39;Save&#39;</span> or $action eq <span class="stringliteral">&#39;Save as:&#39;</span> or $action eq <span class="stringliteral">&#39;Save as Default&#39;</span>) {
    
<span class="preprocessor">        #warn &quot;FIXME Saving files  action = $action  outputFileName=$output_file&quot;;</span>
<span class="preprocessor"></span>        
<span class="preprocessor">        #################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # construct message body</span>
<span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<span class="preprocessor"></span>        my $temp_body = ${ $r_text };
        $temp_body =~ s/\<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>\n/\n/g;
        $temp_body = join(<span class="stringliteral">&quot;&quot;</span>,
                   <span class="stringliteral">&quot;From: $from \nReply-To: $replyTo\n&quot;</span> ,
                   <span class="stringliteral">&quot;Subject: $subject\n&quot;</span> ,
                   <span class="stringliteral">&quot;Message: \n    $temp_body&quot;</span>);
<span class="preprocessor">        #warn &quot;FIXME from $from | subject $subject |reply $replyTo|msg $temp_body&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # overwrite protection</span>
<span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ($action eq <span class="stringliteral">&#39;Save as:&#39;</span> and -e <span class="stringliteral">&quot;$emailDirectory/$output_file&quot;</span>) {
            $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;The file $emailDirectory/$output_file already exists and cannot be overwritten&quot;</span>,
                                     <span class="stringliteral">&quot;The message was not saved&quot;</span>));
            <span class="keywordflow">return</span>;
        }
 
<span class="preprocessor">        #################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Back up existing file?</span>
<span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ($action eq <span class="stringliteral">&#39;Save as Default&#39;</span> and -e <span class="stringliteral">&quot;$emailDirectory/$default_msg_file&quot;</span>) {
            rename(<span class="stringliteral">&quot;$emailDirectory/$default_msg_file&quot;</span>,<span class="stringliteral">&quot;$emailDirectory/$old_default_msg_file&quot;</span>) or 
                   die &quot;Can&#39;t rename $emailDirectory/$default_msg_file to $emailDirectory/$old_default_msg_file &quot;,
                       &quot;Check permissions for webserver on directory $emailDirectory. $!&quot;;
            $self-&gt;<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a67503edcfa4afa8593865060504882f2">addgoodmessage</a>(CGI::p(&quot;Backup file &lt;code&gt;$emailDirectory/$old_default_msg_file&lt;/code&gt; created.&quot; . CGI::br()));
        }
        <span class="preprocessor">#################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Save the message</span>
<span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<span class="preprocessor"></span>        $self-&gt;saveProblem($temp_body, <span class="stringliteral">&quot;${emailDirectory}/$output_file&quot;</span> ) unless ($output_file =~ /^[~.]/ || $output_file =~ /\.\./ || not $output_file =~ m|\.msg$|);
        unless ( $self-&gt;{submit_message} or not -w <span class="stringliteral">&quot;${emailDirectory}/$output_file&quot;</span> )  {  # <span class="keywordflow">if</span> there are no errors report success
            $self-&gt;addgoodmessage(CGI::p(<span class="stringliteral">&quot;Message saved to file &lt;code&gt;${emailDirectory}/$output_file&lt;/code&gt;.&quot;</span>));
        }    

    } elsif ($action eq <span class="stringliteral">&#39;Preview message&#39;</span>) {
        $self-&gt;{response}         = <span class="stringliteral">&#39;preview&#39;</span>;
    
    } elsif ($action eq <span class="stringliteral">&#39;Send Email&#39;</span>) {
<span class="preprocessor">        # verify format of From address (one valid rfc2822 address)</span>
<span class="preprocessor"></span>        my @parsed_from_addrs = Email::Address-&gt;parse($self-&gt;{from});
        unless (@parsed_from_addrs == 1) {
            $self-&gt;addbadmessage(<span class="stringliteral">&quot;From field must contain one valid email address.&quot;</span>);
            <span class="keywordflow">return</span>;
        }
        
<span class="preprocessor">        # verify format of Reply-to address (zero or more valid rfc2822 addresses)</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (defined $self-&gt;{replyTo} and $self-&gt;{replyTo} ne <span class="stringliteral">&quot;&quot;</span>) {
            my @parsed_replyto_addrs = Email::Address-&gt;parse($self-&gt;{replyTo});
            unless (@parsed_replyto_addrs &gt; 0) {
                $self-&gt;addbadmessage(<span class="stringliteral">&quot;Invalid Reply-to address.&quot;</span>);
                <span class="keywordflow">return</span>;
            }
        }
        
<span class="preprocessor">        # check that recipients have been selected.</span>
<span class="preprocessor"></span>        my @recipients            = @{$self-&gt;{ra_send_to}};
        unless (@recipients) {
            $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;No recipients selected. Please select one or more recipients from the list below.&quot;</span>));
            <span class="keywordflow">return</span>;
        }
        
<span class="preprocessor">        #  get merge file</span>
<span class="preprocessor"></span>        my $merge_file      = ( defined($self-&gt;{merge_file}) ) ? $self-&gt;{merge_file} : <span class="stringliteral">&#39;None&#39;</span>;
        my $delimiter       = <span class="charliteral">&#39;,&#39;</span>;
        my $rh_merge_data   = $self-&gt;read_scoring_file(<span class="stringliteral">&quot;$merge_file&quot;</span>, <span class="stringliteral">&quot;$delimiter&quot;</span>);
        unless (ref($rh_merge_data) ) {
            $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;No merge data file&quot;</span>));
            $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Can&#39;t read merge file $merge_file. No message sent&quot;</span>));
            <span class="keywordflow">return</span>;
        } ;
        $self-&gt;{rh_merge_data} = $rh_merge_data;
        
<span class="preprocessor">        # we don&#39;t set the response until we&#39;re sure that email can be sent</span>
<span class="preprocessor"></span>        $self-&gt;{response}         = <span class="stringliteral">&#39;send_email&#39;</span>;
        
<span class="preprocessor">        # FIXME i&#39;m not sure why we&#39;re pulling this out here -- mail_message_to_recipients does have</span>
<span class="preprocessor"></span><span class="preprocessor">        # access to the course environment and should just grab it directly</span>
<span class="preprocessor"></span>        $self-&gt;{smtpServer}    = $ce-&gt;{mail}-&gt;{smtpServer};
        
<span class="preprocessor">        # do actual mailing in the cleanup phase, since it could take a long time</span>
<span class="preprocessor"></span><span class="preprocessor">        # FIXME we need to do a better job providing status notifications for long-running email jobs</span>
<span class="preprocessor"></span>        my $post_connection_action = sub {
            my $r = shift; 
<span class="preprocessor">            # catch exceptions generated during the sending process</span>
<span class="preprocessor"></span>            my $result_message = eval { $self-&gt;mail_message_to_recipients() };
            <span class="keywordflow">if</span> ($@) {
<span class="preprocessor">                # add the die message to the result message</span>
<span class="preprocessor"></span>                $result_message = <span class="stringliteral">&quot;An error occurred while trying to send email.\n&quot;</span>
                    . <span class="stringliteral">&quot;The error message is:\n\n$@\n\n&quot;</span>;
<span class="preprocessor">                # and also write it to the apache log</span>
<span class="preprocessor"></span>                $self-&gt;r-&gt;log-&gt;error(<span class="stringliteral">&quot;An error occurred while trying to send email: $@&quot;</span>);
            }
<span class="preprocessor">            # this could fail too...</span>
<span class="preprocessor"></span>            eval { $self-&gt;email_notification($result_message) };
            <span class="keywordflow">if</span> ($@) {
                $self-&gt;r-&gt;log-&gt;error(<span class="stringliteral">&quot;An error occured while trying to send the email notification: $@&quot;</span>);
            }
        };
        <span class="keywordflow">if</span> (MP2) {
            $r-&gt;connection-&gt;pool-&gt;cleanup_register($post_connection_action);
        } <span class="keywordflow">else</span> {
            $r-&gt;post_connection($post_connection_action);
        }
    } <span class="keywordflow">else</span> {
        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Didn&#39;t recognize button $action&quot;</span>));
    }



}  #end <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a96bb4ab8f03d755b738f9de649883cf7">initialize</a>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="adf7f3bab2717d018779f3d45a611d16d"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::mail_message_to_recipients" ref="adf7f3bab2717d018779f3d45a611d16d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::mail_message_to_recipients </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-mail_message_to_recipients' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-mail_message_to_recipients-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-mail_message_to_recipients-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-mail_message_to_recipients-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in mail_message_to_recipients: 62</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#adf7f3bab2717d018779f3d45a611d16d">mail_message_to_recipients</a> {
    my $self                  = shift;
    my $r                     = $self-&gt;r;
    my $ce                    = $r-&gt;ce;
    my $subject               = $self-&gt;{subject};
    my $from                  = $self-&gt;{from};
    my @recipients            = @{$self-&gt;{ra_send_to}};
    my $rh_merge_data         = $self-&gt;{rh_merge_data};
    my $merge_file            = $self-&gt;{merge_file};  
    my $result_message        = <span class="stringliteral">&#39;&#39;</span>;
    my $failed_messages        = 0;
    
    <span class="keywordflow">foreach</span> my $recipient (@recipients) {
<span class="preprocessor">            # warn &quot;FIXME sending email to $recipient&quot;;</span>
<span class="preprocessor"></span>            my $error_messages = <span class="stringliteral">&#39;&#39;</span>;
            my $ur      = $self-&gt;{db}-&gt;getUser($recipient); #checked
            unless ($ur) {
                $error_messages .= <span class="stringliteral">&quot;Record for user $recipient not found\n&quot;</span>;
                next;
            }
            unless ($ur-&gt;email_address) {
                $error_messages .=<span class="stringliteral">&quot;User $recipient does not have an email address -- skipping\n&quot;</span>;
                next;
            }
            my $msg = eval { $self-&gt;process_message($ur,$rh_merge_data) };
            $error_messages .= <span class="stringliteral">&quot;There were errors in processing user $recipient, merge file $merge_file. \n$@\n&quot;</span> <span class="keywordflow">if</span> $@;
            my $mailer = Mail::Sender-&gt;new({
                from      =&gt; $ce-&gt;{mail}{smtpSender},
                fake_from =&gt; $from,
                to        =&gt; $ur-&gt;email_address,
                smtp      =&gt; $self-&gt;{smtpServer},
                subject   =&gt; $subject,
                headers   =&gt; <span class="stringliteral">&quot;X-Remote-Host: &quot;</span>.$self-&gt;{remote_host},
            });
            unless (ref $mailer) {
                $error_messages .= <span class="stringliteral">&quot;Failed to create a mailer for user $recipient: $Mail::Sender::Error\n&quot;</span>;
                next;
            }
            unless (ref $mailer-&gt;Open()) {
                $error_messages .= <span class="stringliteral">&quot;Failed to open the mailer for user $recipient: $Mail::Sender::Error\n&quot;</span>;
                next;
            }
            my $MAIL         = $mailer-&gt;GetHandle() || ($error_messages .= <span class="stringliteral">&quot;Couldn&#39;t get mailer handle \n&quot;</span>);
            print $MAIL        $msg                 || ($error_messages .= <span class="stringliteral">&quot;Couldn&#39;t print to $MAIL&quot;</span>);
            close $MAIL                             || ($error_messages .= <span class="stringliteral">&quot;Couldn&#39;t close $MAIL&quot;</span>);
<span class="preprocessor">            #warn &quot;FIXME mailed to $recipient: &quot;, $ur-&gt;email_address, &quot; from $from subject $subject Errors: $error_messages&quot;;</span>
<span class="preprocessor"></span>            $failed_messages++ <span class="keywordflow">if</span> $error_messages;
            $result_message .= $error_messages;          
        } 
        my $courseName = $self-&gt;r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
        my $number_of_recipients = scalar(@recipients) - $failed_messages;
        $result_message = &lt;&lt;EndText.$result_message;
        
            A <a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a> with the subject line 
                         $subject 
            has been sent to 
            $number_of_recipients recipient(s) in the class $courseName. 
            There were $failed_messages <a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a>(s) that could not be delivered. 
        
EndText

}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a67e075f06e67f3a054b19572a8d639e7"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::print_form" ref="a67e075f06e67f3a054b19572a8d639e7" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::print_form </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-print_form' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-print_form-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-print_form-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-print_form-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in print_form: 194</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a67e075f06e67f3a054b19572a8d639e7">print_form</a> {
    my ($self)          = @_;
    my $r               = $self-&gt;r;
    my $urlpath         = $r-&gt;urlpath;
    my $authz           = $r-&gt;authz;    
    my $db              = $r-&gt;db;
    my $ce              = $r-&gt;ce;
    my $courseName      = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
    my $setID           = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);    
    my $user            = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);

    my $root            = $ce-&gt;{webworkURLs}-&gt;{root};
    my $sendMailPage    = $urlpath-&gt;newFromModule($urlpath-&gt;module, $r, courseID=&gt;$courseName);
    my $sendMailURL     = $self-&gt;systemLink($sendMailPage, authen =&gt; 0);

        <span class="keywordflow">return</span> CGI::em(<span class="stringliteral">&quot;You are not authorized to access the Instructor tools.&quot;</span>) unless $authz-&gt;hasPermissions($user, &quot;access_instructor_tools&quot;);

    my $userTemplate = $db-&gt;newUser;
    my $permissionLevelTemplate = $db-&gt;newPermissionLevel;
    
    <span class="preprocessor"># This code will require changing if the permission and user tables ever have different keys.</span>
<span class="preprocessor"></span>    my @users                 = sort @{ $self-&gt;{ra_users} };
    my $ra_user_records       = $self-&gt;{ra_user_records};
    my %classlistLabels       = ();#  %$hr_classlistLabels;
    <span class="keywordflow">foreach</span> my $ur (@{ $ra_user_records }) {
        $classlistLabels{$ur-&gt;user_id} = $ur-&gt;user_id.<span class="stringliteral">&#39;: &#39;</span>.$ur-&gt;last_name. <span class="stringliteral">&#39;, &#39;</span>. $ur-&gt;first_name.<span class="stringliteral">&#39; -- &#39;</span>.$ur-&gt;section.<span class="stringliteral">&quot; / &quot;</span>.$ur-&gt;recitation;
    }

<span class="preprocessor">    ## Mark edit define scrolling list</span>
<span class="preprocessor"></span>    my $scrolling_user_list = scrollingRecordList({
        name =&gt; <span class="stringliteral">&quot;classList&quot;</span>,            ## changed from classList to action
        request =&gt; $r,
        default_sort =&gt; <span class="stringliteral">&quot;lnfn&quot;</span>,
        default_format =&gt; <span class="stringliteral">&quot;lnfn_uid&quot;</span>,
        default_filters =&gt; [<span class="stringliteral">&quot;all&quot;</span>],
        size =&gt; 5,
        multiple =&gt; 1,
        refresh_button_name =&gt;<span class="stringliteral">&#39;Update settings and refresh page&#39;</span>,
    }, @{$ra_user_records});

<span class="preprocessor">    ##############################################################################################################</span>
<span class="preprocessor"></span>    

    my $from            = $self-&gt;{from};
    my $subject         = $self-&gt;{subject};
    my $replyTo         = $self-&gt;{replyTo};
    my $columns         = $self-&gt;{columns};
    my $rows            = $self-&gt;{rows};
    my $text            = defined($self-&gt;{r_text}) ? ${ $self-&gt;{r_text} }: <span class="stringliteral">&#39;FIXME no text was produced by initialization!!&#39;</span>;
    my $input_file      = $self-&gt;{input_file};
    my $output_file     = $self-&gt;{output_file};
    my @sorted_messages = $self-&gt;get_message_file_names;
    my @sorted_merge_files = $self-&gt;get_merge_file_names;
    my $merge_file      = ( defined($self-&gt;{merge_file}) ) ? $self-&gt;{merge_file} : <span class="stringliteral">&#39;None&#39;</span>;
    my $delimiter       = <span class="charliteral">&#39;,&#39;</span>;
    my $rh_merge_data   = $self-&gt;read_scoring_file(<span class="stringliteral">&quot;$merge_file&quot;</span>, <span class="stringliteral">&quot;$delimiter&quot;</span>);
    my @merge_keys      = keys %$rh_merge_data;
    my $preview_user    = $self-&gt;{preview_user};
    my $preview_record   = $db-&gt;getUser($preview_user); # checked
    die <span class="stringliteral">&quot;record for preview user &quot;</span>.$self-&gt;{preview_user}. <span class="stringliteral">&quot; not found.&quot;</span> unless $preview_record;


<span class="preprocessor">    #############################################################################################       </span>
<span class="preprocessor"></span>
    print CGI::start_form({method=&gt;<span class="stringliteral">&quot;post&quot;</span>, action=&gt;$sendMailURL});
    print $self-&gt;hidden_authen_fields();
<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #   begin upper table</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<span class="preprocessor"></span>
    print CGI::start_table({-border=&gt;<span class="charliteral">&#39;2&#39;</span>, -cellpadding=&gt;<span class="charliteral">&#39;4&#39;</span>});
    print CGI::Tr({-align=&gt;<span class="stringliteral">&#39;left&#39;</span>,-valign=&gt;<span class="stringliteral">&#39;top&#39;</span>},
<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #   first column</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<span class="preprocessor"></span>
             CGI::td({},
                 CGI::strong(<span class="stringliteral">&quot;Message file: &quot;</span>), $input_file,<span class="stringliteral">&quot;\n&quot;</span>,CGI::br(),
                 CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Open&#39;</span>), <span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span>,<span class="stringliteral">&quot;\n&quot;</span>,
                 CGI::popup_menu(-name=&gt;<span class="stringliteral">&#39;openfilename&#39;</span>, 
                                 -values=&gt;\@sorted_messages, 
                                 -<span class="keywordflow">default</span>=&gt;$input_file
                 ), 
                 <span class="stringliteral">&quot;\n&quot;</span>,CGI::br(),
                 CGI::strong(<span class="stringliteral">&quot;Save file to: &quot;</span>), $output_file,
                 <span class="stringliteral">&quot;\n&quot;</span>,CGI::br(),
                 CGI::strong(<span class="stringliteral">&#39;Merge file: &#39;</span>), $merge_file, 
                 CGI::br(),
                 CGI::popup_menu(-name=&gt;<span class="stringliteral">&#39;merge_file&#39;</span>, 
                                 -values=&gt;\@sorted_merge_files, 
                                 -<span class="keywordflow">default</span>=&gt;$merge_file,
                 ), <span class="stringliteral">&quot;\n&quot;</span>,
                 <span class="stringliteral">&quot;\n&quot;</span>,
<span class="preprocessor">                 #CGI::hr(),</span>
<span class="preprocessor"></span>                 CGI::div({style=&gt;<span class="stringliteral">&quot;background-color: #CCCCCC&quot;</span>},
                     <span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&#39;From:&#39;</span>,<span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span>,  CGI::textfield(-name=&gt;<span class="stringliteral">&quot;from&quot;</span>, -size=&gt;30, -value=&gt;$from, -<span class="keyword">override</span>=&gt;1),    
                     <span class="stringliteral">&quot;\n&quot;</span>, CGI::br(),<span class="stringliteral">&#39;Reply-To: &#39;</span>, CGI::textfield(-name=&gt;<span class="stringliteral">&quot;replyTo&quot;</span>, -size=&gt;30, -value=&gt;$replyTo, -<span class="keyword">override</span>=&gt;1), 
                     <span class="stringliteral">&quot;\n&quot;</span>, CGI::br(),<span class="stringliteral">&#39;Subject:  &#39;</span>, CGI::br(), CGI::textarea(-name=&gt;<span class="stringliteral">&#39;subject&#39;</span>, -<span class="keywordflow">default</span>=&gt;$subject, -rows=&gt;3,-cols=&gt;30, -<span class="keyword">override</span>=&gt;1),  
                ),
                #CGI::hr(),
                <span class="stringliteral">&quot;Editor rows: &quot;</span>, CGI::textfield(-name=&gt;<span class="stringliteral">&#39;rows&#39;</span>, -size=&gt;3, -value=&gt;$rows),
                <span class="stringliteral">&quot; columns: &quot;</span>, CGI::textfield(-name=&gt;<span class="stringliteral">&#39;columns&#39;</span>, -size=&gt;3, -value=&gt;$columns),
                CGI::br(),
                CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;$UPDATE_SETTINGS_BUTTON),
                 
            ),
    #############################################################################################
    #   second column
    #############################################################################################   

    ## Edit by Mark to insert scrolling list
                    CGI::td({-style=&gt;<span class="stringliteral">&quot;width:33%&quot;</span>},
                         CGI::strong(<span class="stringliteral">&quot;Send to:&quot;</span>),
                          CGI::radio_group(-name=&gt;<span class="stringliteral">&#39;radio&#39;</span>, 
                                           -values=&gt;[<span class="stringliteral">&#39;all_students&#39;</span>,<span class="stringliteral">&#39;studentID&#39;</span>],
                                           -labels=&gt;{all_students=&gt;<span class="stringliteral">&#39;All students in course&#39;</span>,studentID =&gt; <span class="stringliteral">&#39;Selected students&#39;</span>},
                                           -<span class="keywordflow">default</span>=&gt;<span class="stringliteral">&#39;studentID&#39;</span>, -linebreak=&gt;0), 
                            CGI::br(),$scrolling_user_list,
                            CGI::i(<span class="stringliteral">&quot;Preview set to: &quot;</span>), $preview_record-&gt;last_name,<span class="charliteral">&#39;(&#39;</span>, $preview_record-&gt;user_id,<span class="charliteral">&#39;)&#39;</span>,
                            CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;preview&#39;</span>,-label=&gt;<span class="stringliteral">&#39;Preview message&#39;</span>),<span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&#39;</span>,
                    ),
    ); # end Tr
    
<span class="preprocessor">    # second row, for reference popup menu</span>
<span class="preprocessor"></span>    print CGI::Tr(
            CGI::td({align=&gt;<span class="stringliteral">&#39;center&#39;</span>,colspan=&gt;2},

                
<span class="preprocessor">                #CGI::i(&#39;Press any action button to update display&#39;),CGI::br(),</span>
<span class="preprocessor"></span><span class="preprocessor">            #show available macros</span>
<span class="preprocessor"></span>                CGI::popup_menu(
                        -name=&gt;<span class="stringliteral">&#39;dummyName&#39;</span>,
                        -values=&gt;[<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;$SID&#39;</span>, <span class="stringliteral">&#39;$FN&#39;</span>, <span class="stringliteral">&#39;$LN&#39;</span>, <span class="stringliteral">&#39;$SECTION&#39;</span>, <span class="stringliteral">&#39;$RECITATION&#39;</span>,<span class="stringliteral">&#39;$STATUS&#39;</span>, <span class="stringliteral">&#39;$EMAIL&#39;</span>, <span class="stringliteral">&#39;$LOGIN&#39;</span>, <span class="stringliteral">&#39;$COL[3]&#39;</span>, <span class="stringliteral">&#39;$COL[-1]&#39;</span>],
                        -labels=&gt;{<span class="stringliteral">&#39;&#39;</span>=&gt;<span class="stringliteral">&#39;list of insertable macros&#39;</span>,
                            <span class="stringliteral">&#39;$SID&#39;</span>=&gt;<span class="stringliteral">&#39;$SID - Student ID&#39;</span>,
                            <span class="stringliteral">&#39;$FN&#39;</span>=&gt;<span class="stringliteral">&#39;$FN - First name&#39;</span>,
                            <span class="stringliteral">&#39;$LN&#39;</span>=&gt;<span class="stringliteral">&#39;$LN - Last name&#39;</span>,
                            <span class="stringliteral">&#39;$SECTION&#39;</span>=&gt;<span class="stringliteral">&#39;$SECTION&#39;</span>,
                            <span class="stringliteral">&#39;$RECITATION&#39;</span>=&gt;<span class="stringliteral">&#39;$RECITATION&#39;</span>,
                            <span class="stringliteral">&#39;$STATUS&#39;</span>=&gt;<span class="stringliteral">&#39;$STATUS - C, Audit, Drop, etc.&#39;</span>,
                            <span class="stringliteral">&#39;$EMAIL&#39;</span>=&gt;<span class="stringliteral">&#39;$EMAIL - Email address&#39;</span>,
                            <span class="stringliteral">&#39;$LOGIN&#39;</span>=&gt;<span class="stringliteral">&#39;$LOGIN - Login&#39;</span>,
                            <span class="stringliteral">&#39;$COL[3]&#39;</span>=&gt;<span class="stringliteral">&#39;$COL[3] - 3rd col&#39;</span>,
                            <span class="stringliteral">&#39;$COL[-1]&#39;</span>=&gt;<span class="stringliteral">&#39;$COL[-1] - Last column&#39;</span>
                            }
                ), <span class="stringliteral">&quot;\n&quot;</span>,
            ),
    );
    
    print CGI::end_table(); 
<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #   end upper table</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<span class="preprocessor"></span> 
<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #   merge file fragment and message text area field</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<span class="preprocessor"></span>    my @tmp2;
    eval{  @tmp2= @{$rh_merge_data-&gt;{ $db-&gt;getUser($preview_user)-&gt;student_id  }  };}; # checked
    <span class="keywordflow">if</span> ($@ and $merge_file ne <span class="stringliteral">&#39;None&#39;</span>) {
        print <span class="stringliteral">&quot;No merge data for $preview_user in merge file: &amp;lt;$merge_file&amp;gt;&quot;</span>,CGI::br();
    } <span class="keywordflow">else</span> {
        print CGI::pre(<span class="stringliteral">&quot;&quot;</span>,<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a1d096ed4e84c99a5542ebc61cd70d36d">data_format</a>(1..($#tmp2+1)),<span class="stringliteral">&quot;&lt;br&gt;&quot;</span>, <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a45b899af631c3ea1cd2e15f9452f644e">data_format2</a>(@tmp2));
    }
<span class="preprocessor">    #create a textbox with the subject and a textarea with the message</span>
<span class="preprocessor"></span><span class="preprocessor">    #print actual body of message</span>
<span class="preprocessor"></span>
    print  <span class="stringliteral">&quot;\n&quot;</span>, CGI::p( $self-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a>}) <span class="keywordflow">if</span> defined($self-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a>});  
    print  <span class="stringliteral">&quot;\n&quot;</span>, CGI::p( CGI::textarea(-name=&gt;<span class="stringliteral">&#39;body&#39;</span>, -<span class="keywordflow">default</span>=&gt;$text, -rows=&gt;$rows, -cols=&gt;$columns, -<span class="keyword">override</span>=&gt;1));

<span class="preprocessor">    #############################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #   action button table</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<span class="preprocessor"></span>    print    CGI::table( { -border=&gt;2,-cellpadding=&gt;4},
                 CGI::Tr( {},
                     CGI::td({}, CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Send Email&#39;</span>) ), <span class="stringliteral">&quot;\n&quot;</span>,
                     CGI::td({}, CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Save&#39;</span>),<span class="stringliteral">&quot; to $output_file&quot;</span>), <span class="stringliteral">&quot; \n&quot;</span>,
                     CGI::td({}, CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Save as:&#39;</span>),
                             CGI::textfield(-name=&gt;<span class="stringliteral">&#39;savefilename&#39;</span>, -size =&gt; 20, -value=&gt; <span class="stringliteral">&quot;$output_file&quot;</span>, -<span class="keyword">override</span>=&gt;1)
                     ), <span class="stringliteral">&quot;\n&quot;</span>,
                     CGI::td(CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Save as Default&#39;</span>)),
                ) 
    );
               
<span class="preprocessor">    ##############################################################################################################</span>
<span class="preprocessor"></span>
    print CGI::end_form();  
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
}

<span class="preprocessor">##############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor"># Utility methods</span>
<span class="preprocessor">##############################################################################</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a90aea456cc32786c82e3b58e8da98c42"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::print_preview" ref="a90aea456cc32786c82e3b58e8da98c42" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::print_preview </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-print_preview' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-print_preview-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-print_preview-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-print_preview-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in print_preview: 44</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a90aea456cc32786c82e3b58e8da98c42">print_preview</a> {
    my ($self)          = @_;
    my $r               = $self-&gt;r;
    my $urlpath         = $r-&gt;urlpath;
    my $setID           = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);    

<span class="preprocessor">    #  get preview user</span>
<span class="preprocessor"></span>    my $ur      = $r-&gt;db-&gt;getUser($self-&gt;{preview_user}); #checked
    die <span class="stringliteral">&quot;record for preview user &quot;</span>.$self-&gt;{preview_user}. <span class="stringliteral">&quot; not found.&quot;</span> unless $ur;
    
<span class="preprocessor">    #  get merge file</span>
<span class="preprocessor"></span>    my $merge_file      = ( defined($self-&gt;{merge_file}) ) ? $self-&gt;{merge_file} : <span class="stringliteral">&#39;None&#39;</span>;
    my $delimiter       = <span class="charliteral">&#39;,&#39;</span>;
    my $rh_merge_data   = $self-&gt;read_scoring_file(<span class="stringliteral">&quot;$merge_file&quot;</span>, <span class="stringliteral">&quot;$delimiter&quot;</span>);

    my ($msg, $preview_header) = $self-&gt;process_message($ur,$rh_merge_data,1); # 1 == <span class="keywordflow">for</span> preview
    
    my $recipients  = join(<span class="stringliteral">&quot; &quot;</span>,@{$self-&gt;{ra_send_to} });
    my $errorMessage =  defined($self-&gt;{submit_message}) ?  CGI::i($self-&gt;{submit_message} ) : <span class="stringliteral">&#39;&#39;</span> ; 
    
<span class="preprocessor">    # Format message keeping the preview_header lined up</span>
<span class="preprocessor"></span>    $errorMessage = wrap(<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,$errorMessage);
    $msg = wrap(<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,$msg);
    
    $msg = join(<span class="stringliteral">&quot;&quot;</span>,
       $errorMessage,
       $preview_header,
       <span class="stringliteral">&quot;To: &quot;</span>             , $ur-&gt;email_address,<span class="stringliteral">&quot;\n&quot;</span>,
       <span class="stringliteral">&quot;From: &quot;</span>           , $self-&gt;{from} , <span class="stringliteral">&quot;\n&quot;</span> ,
       <span class="stringliteral">&quot;Reply-To: &quot;</span>       , $self-&gt;{replyTo} , <span class="stringliteral">&quot;\n&quot;</span> ,
       <span class="stringliteral">&quot;Subject:  &quot;</span>       , $self-&gt;{subject} , <span class="stringliteral">&quot;\n&quot;</span> ,<span class="stringliteral">&quot;\n&quot;</span> , 
       $msg , <span class="stringliteral">&quot;\n&quot;</span>
    );

<span class="preprocessor">#   return join(&quot;&quot;, &#39;&lt;pre&gt;&#39;,wrap(&quot;&quot;,&quot;&quot;,$msg),&quot;\n&quot;,&quot;\n&quot;,</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> join(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&#39;&lt;pre&gt;&#39;</span>,$msg,<span class="stringliteral">&quot;\n&quot;</span>,<span class="stringliteral">&quot;\n&quot;</span>,
                   <span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>, 
                   CGI::p(<span class="stringliteral">&#39;Use browser back button to return from preview mode&#39;</span>),
                   CGI::h3(<span class="stringliteral">&#39;Emails to be sent to the following:&#39;</span>), 
                   $recipients, <span class="stringliteral">&quot;\n&quot;</span>,
                   
    );

}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a6ea957f71c531694c04ad864166995ed"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::process_message" ref="a6ea957f71c531694c04ad864166995ed" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::process_message </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-process_message' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-process_message-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-process_message-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-process_message-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in process_message: 64</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a6ea957f71c531694c04ad864166995ed">process_message</a> {
    my $self          = shift;
    my $ur            = shift;
    my $rh_merge_data = shift;
    my $for_preview   = shift;
    my $text          = defined($self-&gt;{r_text}) ? ${ $self-&gt;{r_text} }:
                            <span class="stringliteral">&#39;FIXME no text was produced by initialization!!&#39;</span>;   
    my $merge_file      = ( defined($self-&gt;{merge_file}) ) ? $self-&gt;{merge_file} : <span class="stringliteral">&#39;None&#39;</span>;  
    
    my $status_name = $self-&gt;r-&gt;ce-&gt;status_abbrev_to_name($ur-&gt;status);
    $status_name = $ur-&gt;status unless defined $status_name;
    
<span class="preprocessor">    #user macros that can be used in the email message</span>
<span class="preprocessor"></span>    my $SID           = $ur-&gt;student_id;
    my $FN            = $ur-&gt;first_name;
    my $LN            = $ur-&gt;last_name;
    my $SECTION       = $ur-&gt;section;
    my $RECITATION    = $ur-&gt;recitation;
    my $STATUS        = $status_name;
    my $EMAIL         = $ur-&gt;email_address;
    my $LOGIN         = $ur-&gt;user_id;
    
<span class="preprocessor">    # get record from merge file</span>
<span class="preprocessor"></span><span class="preprocessor">    # FIXME this is inefficient.  The info should be cached</span>
<span class="preprocessor"></span>    my @COL            = defined($rh_merge_data-&gt;{$SID}) ? @{$rh_merge_data-&gt;{$SID} } : ();
    <span class="keywordflow">if</span> ($merge_file ne <span class="stringliteral">&#39;None&#39;</span> and not defined($rh_merge_data-&gt;{$SID}) and $for_preview) {
        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;No merge data for student id:$SID; name:$FN $LN; login:$LOGIN&quot;</span>));
    }
    unshift(@COL,<span class="stringliteral">&quot;&quot;</span>);           ## <span class="keyword">this</span> makes COL[1] the first column
    my $endCol = @COL;
<span class="preprocessor">    # for safety, only evaluate special variables</span>
<span class="preprocessor"></span>    my $msg = $text;    
    $msg =~ s/\$SID/$SID/ge;
    $msg =~ s/\$LN/$LN/ge;
    $msg =~ s/\$FN/$FN/ge;
    $msg =~ s/\$STATUS/$STATUS/ge;
    $msg =~ s/\$SECTION/$SECTION/ge;
    $msg =~ s/\$RECITATION/$RECITATION/ge;
    $msg =~ s/\$EMAIL/$EMAIL/ge;
    $msg =~ s/\$LOGIN/$LOGIN/ge;
    <span class="keywordflow">if</span> (defined($COL[1])) {     # prevents extraneous error messages.  
        $msg =~ s/\$COL\[(\-?\d+)\]/$COL[$1]/ge
    }
    <span class="keywordflow">else</span> {                      # prevents extraneous $COL<span class="stringliteral">&#39;s in email message </span>
<span class="stringliteral">        $msg =~ s/\$COL\[(\-?\d+)\]//g</span>
<span class="stringliteral">    }           </span>
<span class="stringliteral">             </span>
<span class="stringliteral">    $msg =~ s/\r//g;</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    if ($for_preview) {</span>
<span class="stringliteral">        my @preview_COL = @COL;</span>
<span class="stringliteral">        shift @preview_COL; ## shift back for preview</span>
<span class="stringliteral">        my $preview_header =    CGI::p(&#39;</span><span class="stringliteral">&#39;,data_format(1..($#COL)),&quot;&lt;br&gt;&quot;, data_format2(@preview_COL)).</span>
<span class="stringliteral">                                CGI::h3( &quot;This sample mail would be sent to $EMAIL&quot;);</span>
<span class="stringliteral">        return $msg, $preview_header;</span>
<span class="stringliteral">    } else {</span>
<span class="stringliteral">        return $msg;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">}</span>
<span class="stringliteral"></span>
<span class="stringliteral"></span>
<span class="stringliteral">#  sub data_format {</span>
<span class="stringliteral"># </span>
<span class="stringliteral">#     map {$_ =~s/\s/\./g;$_}   map {sprintf(&#39;</span>%-8.8s<span class="stringliteral">&#39;,$_);} @_;</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a0581f132ca99cc75b6042102b79b19ae"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::read_input_file" ref="a0581f132ca99cc75b6042102b79b19ae" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::read_input_file </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-read_input_file' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-read_input_file-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-read_input_file-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-read_input_file-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in read_input_file: 33</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a0581f132ca99cc75b6042102b79b19ae">read_input_file</a> {
    my $self         = shift;
    my $filePath     = shift;
    my ($text, @text);
    my $header = <span class="stringliteral">&#39;&#39;</span>;
    my ($subject, $from, $replyTo);
    local(*FILE);
    <span class="keywordflow">if</span> (-e <span class="stringliteral">&quot;$filePath&quot;</span> and -<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a> <span class="stringliteral">&quot;$filePath&quot;</span>) {
        open FILE, <span class="stringliteral">&quot;$filePath&quot;</span> || <span class="keywordflow">do</span> { $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Can&#39;t open $filePath&quot;</span>)); <span class="keywordflow">return</span>};
        <span class="keywordflow">while</span> ($header !~ s/Message:\s*$<span class="comment">//m and not eof(FILE)) { </span>
            $header .= &lt;FILE&gt;; 
        }
        $text = join( <span class="stringliteral">&#39;&#39;</span>, &lt;FILE&gt;);
        $text =~ s/^\s*<span class="comment">//; # remove initial white space if any.</span>
        $header         =~ /^From:\s(.*)$/m;
        $from           = $1 or $from = $self-&gt;{defaultFrom}; 
        
        $header         =~ /^Reply-To:\s(.*)$/m;
        $replyTo        = $1 or $replyTo = $self-&gt;{defaultReply};
        
        $header         =~ /^Subject:\s(.*)$/m;
        $subject        = $1;

    } <span class="keywordflow">else</span> {
        $from           = $self-&gt;{defaultFrom};
        $replyTo        = $self-&gt;{defaultReply};
        $text           =  (-e <span class="stringliteral">&quot;$filePath&quot;</span>) ? <span class="stringliteral">&quot;FIXME file $filePath can&#39;t be read&quot;</span> :<span class="stringliteral">&quot;FIXME file $filePath doesn&#39;t exist&quot;</span>;
        $subject        = $self-&gt;{defaultSubject};
    }
    <span class="keywordflow">return</span> ($from, $replyTo, $subject, \$text);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a415ae4d9de8fd50eab0cda953bec8c39"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::SendMail::saveProblem" ref="a415ae4d9de8fd50eab0cda953bec8c39" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::SendMail::saveProblem </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-saveProblem' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-saveProblem-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-saveProblem-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-saveProblem-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in saveProblem: 13</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html#a415ae4d9de8fd50eab0cda953bec8c39">saveProblem</a> {     
    my $self      = shift;
    my ($body, $probFileName)= @_;
    local(*PROBLEM);
    open (PROBLEM, <span class="stringliteral">&quot;&gt;$probFileName&quot;</span>) ||
        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Could not open $probFileName for writing.</span>
<span class="stringliteral">                        Check that the  permissions for this problem are 660 (-rw-rw----)&quot;</span>));
    print PROBLEM $body <span class="keywordflow">if</span> -w $probFileName;
    close PROBLEM;
    chmod 0660, <span class="stringliteral">&quot;$probFileName&quot;</span> ||
                 $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;CAN&#39;T CHANGE PERMISSIONS ON FILE $probFileName&quot;</span>));
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="SendMail_8pm_source.html">SendMail.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:58:07 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
